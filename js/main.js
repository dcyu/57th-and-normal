// Generated by CoffeeScript 1.6.0
(function() {
  var DOMReady, NS, blueIcon, createLeafletIcons, createVisualization, intervals, map, markerLayer, redIcon,
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  map = null;

  markerLayer = null;

  blueIcon = null;

  redIcon = null;

  intervals = ['2005', '2006', '2007', '2008', '2009', '2010q1', '2010q2', '2010q3', '2010q4', '2011q1', '2011q2', '2011q3', '2011q4', '2012q1', '2012q2', '2012q3', '2012q4', '2013q1', '2013q2', '2013q3', '2013q4'];

  NS = ['NORFOLK SOUTHERN RAILWAY CO', 'NORFOLK & SOUTHERN RAILROAD CORP', 'NORFOLK & SOUTHERN RAILWAY ILLINOIS CONSTRUCTION C', 'NORFOLK SOUTHER RAILWAY CO', 'NORFOLK SOUTHERN CORP', 'NORFOLK SOUTHERN RAILRAY CO', 'NORFOLK SOUTHERN RAILROAD', 'NORFOLK SOUTHERN RAILROAD CORP', 'NORFOLK SOUTHERN RAILWAY', 'NORFOLK SOUTHERN RAILWAY COMPANY', 'NORFOLK SOUTHERN RAILWAY COMPANY', 'NORFOLK SOUTHERN RAILWAY INC', 'NORFOLK SOUTHTERN RAILWAY CO', 'NORTHFOLK SOUTHERN RAILWAY CO'];

  createLeafletIcons = function() {
    blueIcon = L.icon({
      iconUrl: '../js/leaflet/images/button_blue.png',
      iconSize: [25, 25],
      iconAnchor: [12, 12]
    });
    return redIcon = L.icon({
      iconUrl: '../js/leaflet/images/button_red.png',
      iconSize: [25, 25],
      iconAnchor: [12, 12]
    });
  };

  createVisualization = function(d1, d2) {
    var data, datum, deed, deeds, key, lat, lon, obj, pin, s, value, _i, _j, _len, _len1;
    createLeafletIcons();
    markerLayer = new L.LayerGroup();
    data = d1['2011q4'];
    for (_i = 0, _len = data.length; _i < _len; _i++) {
      obj = data[_i];
      pin = obj.pin;
      datum = d2[pin];
      lat = datum.lat;
      lon = datum.lon;
      deeds = datum.deeds;
      s = "";
      for (_j = 0, _len1 = deeds.length; _j < _len1; _j++) {
        deed = deeds[_j];
        for (key in deed) {
          value = deed[key];
          s += "" + pin + ", " + key + ", " + value;
        }
        s += "<br>";
      }
      L.marker([lat, lon], {
        icon: blueIcon
      }).addTo(markerLayer).bindPopup(s);
    }
    markerLayer.addTo(map);
    return $("input[type='range']").on('change', function(e) {
      var grantee, icon, index, interval, _k, _l, _len2, _len3, _results;
      index = e.target.value;
      interval = intervals[index];
      $('.interval p').text(interval);
      markerLayer.clearLayers();
      data = d1[interval];
      _results = [];
      for (_k = 0, _len2 = data.length; _k < _len2; _k++) {
        obj = data[_k];
        pin = obj.pin;
        grantee = obj['first-grantee'];
        icon = __indexOf.call(NS, grantee) >= 0 ? redIcon : blueIcon;
        datum = d2[pin];
        lat = datum.lat;
        lon = datum.lon;
        deeds = datum.deeds;
        s = "";
        for (_l = 0, _len3 = deeds.length; _l < _len3; _l++) {
          deed = deeds[_l];
          for (key in deed) {
            value = deed[key];
            s += "" + pin + ", " + key + ", " + value;
          }
          s += "<br>";
        }
        _results.push(L.marker([lat, lon], {
          icon: icon
        }).addTo(markerLayer).bindPopup(s));
      }
      return _results;
    });
  };

  DOMReady = function() {
    var dfd1, dfd2;
    map = L.map('map').setView([41.7922, -87.6378], 18);
    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    dfd1 = new $.Deferred();
    dfd2 = new $.Deferred();
    $.when(dfd1, dfd2).done(createVisualization);
    $.getJSON('../data/intervals.json').done(function(data) {
      return dfd1.resolve(data);
    });
    $.getJSON('../data/deeds.json').done(function(data) {
      return dfd2.resolve(data);
    });
    return $.getJSON('../data/englewood.geojson').done(function(data) {
      var style;
      style = {
        color: '#000',
        weight: 2,
        opacity: 1.0,
        fillOpacity: 0.2
      };
      return L.geoJson(data, {
        style: style
      }).addTo(map);
    });
  };

  window.addEventListener('DOMContentLoaded', DOMReady, false);

}).call(this);
